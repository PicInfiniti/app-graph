<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>D3 Canvas with Draggable Nodes</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        canvas {
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
<canvas width="800" height="600"></canvas>

<script>
    const canvas = document.querySelector("canvas");
    const context = canvas.getContext("2d");
    const width = canvas.width;
    const height = canvas.height;

    // Example data
    const nodes = d3.range(20).map((d) => ({ id: d }));
    const links = d3.range(nodes.length - 1).map((d) => ({
        source: d,
        target: d + 1,
    }));

    // Force simulation
    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).distance(50))
        .force("charge", d3.forceManyBody().strength(-100))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .on("tick", ticked);

    // Drag behavior
    d3.select(canvas)
        .call(
            d3.drag()
                .subject(dragsubject)
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended)
        );

    function ticked() {
        context.clearRect(0, 0, width, height);

        // Draw links
        context.beginPath();
        links.forEach((d) => {
            context.moveTo(d.source.x, d.source.y);
            context.lineTo(d.target.x, d.target.y);
        });
        context.strokeStyle = "#aaa";
        context.stroke();

        // Draw nodes
        nodes.forEach((d) => {
            context.beginPath();
            context.arc(d.x, d.y, 8, 0, 2 * Math.PI);
            context.fillStyle = "#69b3a2";
            context.fill();
        });
    }

    function dragsubject(event) {
        const x = event.x;
        const y = event.y;
        let subject = null;
        let minDist = Infinity;

        nodes.forEach((node) => {
            const dx = x - node.x;
            const dy = y - node.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 10 && dist < minDist) {
                minDist = dist;
                subject = node;
            }
        });
        return subject;
    }

    function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
    }

    function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
    }

    function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
    }
</script>
</body>
</html>

